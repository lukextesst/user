<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Sistema de Gera√ß√£o de Keys - Among Us Mod Menu">
  <title>MIRA HQ - Terminal de Acesso</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --background-color: #0f1219;
      --panel-bg-color: #1a2433; 
      --panel-border-color: #2d3b52; 
      --panel-highlight-color: #6a93c9; 
      --text-color-light: #e8f1f8; 
      --text-color-medium: #b0bec5; 
      --text-color-dark: #7e8c9a;
      --crewmate-yellow: #ffcb74; 
      --crewmate-yellow-darker: #e6b768;
      --crewmate-yellow-text: #1a1a1a; 
      --impostor-red: #e74c3c;
      --impostor-red-darker: #c0392b;
      --emergency-blue: #3498db;
      --emergency-blue-darker: #2980b9;
      --emergency-text: #ffffff;
      --key-id-color: #4cdbc4;
      --success-color: #2ecc71; 
      --error-color: var(--impostor-red); 
      --info-color: var(--emergency-blue);
      --font-title: 'Orbitron', sans-serif;
      --font-body: 'Space Grotesk', sans-serif;
      --font-monospace: 'Space Grotesk', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      overflow-x: hidden;
      width: 100%;
    }
    body {
      font-family: var(--font-body);
      background-color: var(--background-color);
      color: var(--text-color-light);
      min-height: 100vh;
      padding: 1rem; 
      position: relative;
      display: flex; 
      flex-direction: column; 
      align-items: center;
      opacity: 0;
      animation: bootUp 2s ease-out forwards;
    }

    @keyframes bootUp {
      0% { opacity: 0; transform: scale(0.95); }
      50% { opacity: 0.5; transform: scale(0.98); }
      100% { opacity: 1; transform: scale(1); }
    }

    #starfield {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: -1; overflow: hidden;
    }
    .star {
      position: absolute; background-color: #ffffff; border-radius: 50%;
      animation-timing-function: ease-in-out; animation-iteration-count: infinite;
    }
    .star-layer1 { 
      animation: twinkle 6s infinite, driftSlow 120s infinite linear;
      opacity: 0.6;
    } 
    .star-layer2 { 
      animation: twinkle 4s infinite, driftMedium 80s infinite linear;
      opacity: 0.8;
    }
    .star-layer3 { 
      animation: twinkle 2s infinite, driftFast 40s infinite linear;
      opacity: 1;
    }
    @keyframes driftSlow {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-20px, 10px); }
      50% { transform: translate(10px, -15px); }
      75% { transform: translate(15px, 15px); }
      100% { transform: translate(0, 0); }
    }
    @keyframes driftMedium {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-30px, 15px); }
      50% { transform: translate(15px, -25px); }
      75% { transform: translate(25px, 25px); }
      100% { transform: translate(0, 0); }
    }
    @keyframes driftFast {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-40px, 20px); }
      50% { transform: translate(20px, -35px); }
      75% { transform: translate(35px, 35px); }
      100% { transform: translate(0, 0); }
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    .scanline-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 2; opacity: 0.05;
        background: repeating-linear-gradient(transparent, transparent 2px, rgba(100, 180, 255, 0.1) 3px, rgba(100, 180, 255, 0.1) 4px);
        animation: scanlineAnim 15s linear infinite;
    }
    @keyframes scanlineAnim {
        0% { background-position: 0 0; }
        100% { background-position: 0 100px; }
    }

    /* Header com perfil do usu√°rio */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 580px;
      margin-bottom: 1.5rem;
      position: relative;
    }

    .header-content {
      text-align: left;
      flex-grow: 1;
    }

    .user-profile-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid var(--panel-border-color);
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
      justify-content: flex-end;
    }

    .user-profile-header:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(106, 147, 201, 0.2);
    }

    .user-avatar-header {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--panel-highlight-color);
    }

    .user-info-header {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .username-header {
      font-weight: bold;
      color: var(--text-color-light);
      font-size: 0.9em;
    }

    .discriminator-header {
      color: var(--text-color-medium);
      font-size: 0.8em;
    }

    .container {
      position: relative; z-index: 1; background-color: var(--panel-bg-color);
      padding: 1.5rem; border-radius: 16px; 
      max-width: 580px; width: 100%; margin: auto; 
      border: 3px solid var(--panel-border-color);
      box-shadow: 0 0 35px rgba(45, 59, 82, 0.45), inset 0 0 18px rgba(45, 59, 82, 0.3); 
      text-align: center;
      transform: translateY(20px);
      animation: slideIn 1s ease-out 0.5s forwards;
      overflow: hidden;
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    header { margin-bottom: 1.5rem; }
    header h1 {
      font-family: var(--font-title); color: var(--crewmate-yellow); 
      margin-bottom: 0.75rem; font-size: 1.7em;
      text-transform: uppercase; letter-spacing: 1.5px;
      text-shadow: 0 0 12px rgba(255, 203, 116, 0.7);
    }
    header p.subtitle {
      color: var(--text-color-medium); margin-bottom: 2.5rem;
      font-size: 0.9em; line-height: 1.6; font-style: italic;
    }

    /* Auth Section - Simplificada */
    .auth-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        border: 1px solid var(--panel-border-color);
        text-align: center;
    }

    .discord-auth-btn {
        background: linear-gradient(45deg, #5865F2, #7289DA);
        color: white;
        border: none;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-family: var(--font-title);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.7rem;
        transition: all 0.3s ease;
        width: 100%;
        justify-content: center;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 5px 0px #4752c4, 0 8px 12px rgba(0,0,0,0.3);
    }

    .discord-auth-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 0px #4752c4, 0 10px 15px rgba(88, 101, 242, 0.4);
    }

    .discord-auth-btn:active {
        transform: translateY(1px);
        box-shadow: 0 3px 0px #4752c4, 0 6px 10px rgba(0,0,0,0.3);
    }

    /* Controls */
    .controls-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .control-button {
      background: none;
      border: 2px solid var(--panel-border-color);
      color: var(--text-color-medium);
      padding: 0.8rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .control-button:hover {
      border-color: var(--panel-highlight-color);
      color: var(--panel-highlight-color);
      transform: scale(1.05);
    }

    .control-button.active {
      border-color: var(--crewmate-yellow);
      color: var(--crewmate-yellow);
      box-shadow: 0 0 10px rgba(255, 203, 116, 0.3);
    }

    /* Cooldown */
    .cooldown-section {
      margin-bottom: 1.5rem;
    }

    .cooldown-timer {
      background: rgba(231, 76, 60, 0.1);
      border: 2px solid var(--impostor-red);
      border-radius: 8px;
      padding: 1rem;
      color: var(--impostor-red);
      font-family: var(--font-title);
      font-weight: 700;
      text-align: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    /* Key Limit */
    .key-limit-section {
      margin-bottom: 1.5rem;
    }

    .key-limit-info {
      background: rgba(52, 152, 219, 0.1);
      border: 2px solid var(--info-color);
      border-radius: 8px;
      padding: 1rem;
      color: var(--info-color);
      font-family: var(--font-title);
      font-weight: 600;
      text-align: center;
      line-height: 1.4;
    }

    .key-limit-warning {
      background: rgba(255, 203, 116, 0.1);
      border: 2px solid var(--crewmate-yellow);
      color: var(--crewmate-yellow);
    }

    .key-limit-full {
      background: rgba(231, 76, 60, 0.1);
      border: 2px solid var(--impostor-red);
      color: var(--impostor-red);
    }

    /* Buttons */
    .button-group {
      display: grid; grid-template-columns: 1fr; 
      gap: 1.2rem; margin-bottom: 2.5rem;
    }
    @media (min-width: 500px) { 
      .button-group { grid-template-columns: 1fr 1fr; }
    }
    button {
      font-family: var(--font-title); font-weight: 700; 
      font-size: 0.85rem;
      padding: 1rem 1.2rem; border-radius: 8px; border: none; cursor: pointer;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, background-color 0.15s ease-out;
      display: flex; align-items: center; justify-content: center;
      gap: 0.7rem; position: relative; text-transform: uppercase; letter-spacing: 1px;
      box-shadow: 0 5px 0px var(--shadow-color, #000), 0 8px 12px rgba(0,0,0,0.3);
    }
    #generateBtn {
      background-color: var(--crewmate-yellow); color: var(--crewmate-yellow-text);
      --shadow-color: var(--crewmate-yellow-darker);
    }
    #generateBtn:hover:not([disabled]) {
      background-color: #ffd893; transform: translateY(-3px);
      box-shadow: 0 8px 0px var(--crewmate-yellow-darker), 0 10px 15px rgba(0,0,0,0.25);
    }
    #generateBtn:active:not([disabled]) {
      transform: translateY(1px);
      box-shadow: 0 3px 0px var(--crewmate-yellow-darker), 0 6px 10px rgba(0,0,0,0.3);
    }
    #viewKeysBtn {
      background-color: var(--emergency-blue); color: var(--emergency-text);
      --shadow-color: var(--emergency-blue-darker);
    }
     #viewKeysBtn:hover:not([disabled]) {
      background-color: #5dade2; transform: translateY(-3px);
      box-shadow: 0 8px 0px var(--emergency-blue-darker), 0 10px 15px rgba(0,0,0,0.25);
    }
    #viewKeysBtn:active:not([disabled]) {
      transform: translateY(1px);
      box-shadow: 0 3px 0px var(--emergency-blue-darker), 0 6px 10px rgba(0,0,0,0.3);
    }
    button[disabled] {
      opacity: 0.5; cursor: not-allowed;
      box-shadow: 0 2px 0px rgba(0,0,0,0.4) !important;
    }
    button .spinner {
      display: none; width: 20px; height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.2); 
      border-radius: 50%; animation: spin .7s linear infinite;
    }
    #generateBtn.loading .spinner { border-top-color: var(--crewmate-yellow-text); } 
    #viewKeysBtn.loading .spinner { border-top-color: var(--emergency-text); }
    button.loading .spinner { display: inline-block; }
    button.loading .button-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Key Display */
    .key-display-area {
      background-color: rgba(0,0,0, 0.45); 
      border: 2px solid var(--panel-highlight-color);
      padding: 1.8rem 1.5rem; border-radius: 12px;
      margin: 2.5rem auto; max-width: 95%; min-height: 100px; 
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      box-shadow: inset 0 0 15px rgba(106, 147, 201, 0.25), 0 0 10px rgba(106, 147, 201, 0.1);
      position: relative;
    }

    .key-container { 
      opacity: 0; transform: translateY(15px) scale(0.9);
      transition: opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      width: 100%; 
    }
    .key-container.visible { opacity: 1; transform: translateY(0) scale(1); }

    .key-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      justify-content: center;
      align-items: center;
    }

    .copy-button {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.7rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font-body);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      text-transform: none;
      letter-spacing: 0;
      font-size: 0.9rem;
      box-shadow: 0 3px 0px #27ae60, 0 5px 8px rgba(0,0,0,0.2);
    }

    .copy-button:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 5px 0px #27ae60, 0 7px 12px rgba(0,0,0,0.25);
    }

    .copy-button:active {
      transform: translateY(1px) !important;
      box-shadow: 0 2px 0px #27ae60, 0 4px 6px rgba(0,0,0,0.2) !important;
    }

    .copy-button.copied {
      background: var(--crewmate-yellow);
      color: var(--crewmate-yellow-text);
      animation: copySuccess 0.6s ease;
    }

    @keyframes copySuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--key-id-color), var(--panel-highlight-color));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .key-metadata {
      margin-top: 1rem;
      padding: 0.8rem;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--text-color-medium);
      border-left: 3px solid var(--info-color);
    }

    .key-value-label {
        font-family: var(--font-monospace); font-size: 0.8em;
        color: var(--text-color-medium); margin-bottom: 0.8rem;
        text-transform: uppercase; letter-spacing: 1.5px; font-weight: 500;
    }
    .key-value {
      font-family: var(--font-monospace); font-size: 1.3em; 
      font-weight: 700; color: var(--key-id-color);
      word-break: break-all; letter-spacing: 2px; 
      text-shadow: 0 0 15px var(--key-id-color), 0 0 20px var(--key-id-color);
      padding: 0.3rem; line-height: 1.4;
    }
    .key-value.processing {
        color: var(--text-color-medium); font-style: italic;
        text-shadow: none; animation: pulseProcessing 1.5s infinite ease-in-out;
    }
    @keyframes pulseProcessing {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }

    /* Messages */
    .message-area {
      min-height: 3.2em; margin: 1.8rem 0 1.2rem 0;
      display: flex; align-items: center; justify-content: center;
    }
    .message {
      opacity: 0; transform: scale(0.9);
      transition: opacity .3s ease, transform .3s ease;
      padding: .9rem 1.3rem; border-radius: 8px;
      font-size: 0.85em; font-weight: 500;
      width: 100%; max-width: 420px; 
      border-left-width: 6px; border-left-style: solid;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .message.visible { opacity: 1; transform: scale(1); }
    .message.error   { background-color: rgba(231, 76, 60, 0.1); border-left-color: var(--error-color); color: var(--error-color); }
    .message.success { background-color: rgba(46, 204, 113, 0.1); border-left-color: var(--success-color); color: var(--success-color); }
    .message.info    { background-color: rgba(52, 152, 219, 0.1); border-left-color: var(--info-color); color: var(--info-color); }

    /* Keys List */
    .keys-list-section {
      margin-top: 3rem; padding-top: 2rem;
      border-top: 3px double var(--panel-border-color);
    }
    .keys-list-section h2 {
      font-family: var(--font-title); color: var(--panel-highlight-color);
      font-size: 1.3em; margin-bottom: 1.5rem;
      text-transform: uppercase; letter-spacing: 1px;
      text-shadow: 0 0 8px rgba(106, 147, 201, 0.4);
    }
    .keys-list-section ul {
      list-style: none; max-height: 240px; overflow-y: auto;   
      padding-right: 12px; border: 2px solid var(--panel-border-color); 
      border-radius: 8px; padding: 1rem; background-color: rgba(0,0,0,0.2);
    }
    .keys-list-section li {
      background-color: rgba(44, 62, 80, 0.3);
      padding: 0.9rem 1.2rem; border-radius: 6px; margin-bottom: 0.7rem;
      font-family: var(--font-monospace); font-size: 0.9em;
      color: var(--text-color-light);
      border-left: 5px solid var(--panel-highlight-color);
      transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
      word-break: break-all; display: flex; align-items: center;
    }
    .keys-list-section li:last-child { margin-bottom: 0; }
    .keys-list-section li:hover {
      background-color: rgba(45, 59, 82, 0.5);
      border-left-color: var(--crewmate-yellow);
      transform: translateX(5px);
    }
    .keys-list-section li.no-keys { 
        text-align: center; font-style: italic; color: var(--text-color-dark);
        border-left-color: var(--text-color-dark); justify-content: center;
        background-color: transparent;
    }
    .keys-list-section li::before { 
        content: 'üÜî'; margin-right: 0.8em;
        font-size: 1.1em; opacity: 0.8;
    }
    .keys-list-section li.no-keys::before { content: 'üö´'; }
    .keys-list-section ul::-webkit-scrollbar { width: 12px; }
    .keys-list-section ul::-webkit-scrollbar-track { background: rgba(0,0,0,0.25); border-radius: 6px; border: 1px solid var(--panel-border-color);}
    .keys-list-section ul::-webkit-scrollbar-thumb { background: var(--panel-highlight-color); border-radius: 6px; border: 2px solid rgba(0,0,0,0.25); }
    .keys-list-section ul::-webkit-scrollbar-thumb:hover { background: var(--crewmate-yellow); }
    .keys-list-section ul {
      scrollbar-width: auto; 
      scrollbar-color: var(--panel-highlight-color) rgba(0,0,0,0.25); 
    }

    /* Bottom Buttons */
    .bottom-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      margin-top: 2rem;
    }

    .support-button, .translate-button {
      background: var(--panel-bg-color);
      color: var(--text-color-medium);
      border: 2px solid var(--panel-border-color);
      padding: 0.7rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font-body);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
    }

    .support-button:hover, .translate-button:hover {
      border-color: var(--panel-highlight-color);
      color: var(--panel-highlight-color);
      transform: translateY(-2px);
    }

    /* Discord Widget */
    .discord-widget-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: var(--panel-bg-color);
      border: 3px solid var(--panel-border-color);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 0 35px rgba(45, 59, 82, 0.8);
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }

    .discord-widget-container.active {
      display: block;
      animation: widgetFadeIn 0.3s ease;
    }

    @keyframes widgetFadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .discord-widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--panel-border-color);
    }

    .discord-widget-title {
      font-family: var(--font-title);
      color: var(--crewmate-yellow);
      font-size: 1.2rem;
    }

    .close-widget {
      background: none;
      border: none;
      color: var(--text-color-medium);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close-widget:hover {
      color: var(--impostor-red);
    }

    .discord-widget {
      width: 350px;
      height: 500px;
      border-radius: 8px;
      overflow: hidden;
    }

    .discord-widget iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
    }

    .overlay.active {
      display: block;
      animation: overlayFadeIn 0.3s ease;
    }

    @keyframes overlayFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Achievement Popup */
    .achievement-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--crewmate-yellow);
      color: var(--crewmate-yellow-text);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(255, 203, 116, 0.4);
      transform: translateX(400px);
      transition: transform 0.5s ease;
      z-index: 1000;
      border: 2px solid var(--crewmate-yellow-darker);
      max-width: 300px;
      word-wrap: break-word;
    }

    .achievement-popup.show {
      transform: translateX(0);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
    }

    .profile-modal {
        background-color: var(--panel-bg-color);
        margin: 5% auto;
        padding: 0;
        border: 3px solid var(--panel-border-color);
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 0 50px rgba(106, 147, 201, 0.3);
        position: relative;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .close-modal {
        color: var(--text-color-medium);
        float: right;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        z-index: 10;
        transition: color 0.3s ease;
    }

    .close-modal:hover {
        color: var(--text-color-light);
    }

    .modal-header {
        background: linear-gradient(135deg, rgba(106, 147, 201, 0.2), rgba(76, 219, 196, 0.1));
        padding: 2rem;
        border-radius: 13px 13px 0 0;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        border-bottom: 2px solid var(--panel-border-color);
    }

    .modal-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid var(--panel-highlight-color);
        box-shadow: 0 0 20px rgba(106, 147, 201, 0.5);
    }

    .modal-user-info h3 {
        color: var(--text-color-light);
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        font-family: var(--font-title);
    }

    .user-handle {
        color: var(--text-color-medium);
        margin: 0 0 1rem 0;
        font-size: 1rem;
    }

    .server-badge {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .server-badge.verified {
        background: rgba(46, 204, 113, 0.2);
        color: var(--success-color);
        border: 1px solid var(--success-color);
    }

    .server-badge.missing {
        background: rgba(231, 76, 60, 0.2);
        color: var(--impostor-red);
        border: 1px solid var(--impostor-red);
    }

    .modal-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        padding: 2rem;
    }

    .stat-card {
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--panel-border-color);
        border-radius: 8px;
        padding: 1.2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        border-color: var(--panel-highlight-color);
        box-shadow: 0 5px 15px rgba(106, 147, 201, 0.2);
    }

    .stat-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(106, 147, 201, 0.1);
        border-radius: 8px;
    }

    .stat-info {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        color: var(--text-color-light);
        font-size: 1.3rem;
        font-weight: 700;
        font-family: var(--font-title);
    }

    .stat-label {
        color: var(--text-color-medium);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .modal-actions {
        padding: 0 2rem 2rem 2rem;
        display: flex;
        gap: 1rem;
    }

    .modal-action-btn {
        flex: 1;
        padding: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-family: var(--font-title);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .generate-btn {
        background: var(--crewmate-yellow);
        color: var(--crewmate-yellow-text);
    }

    .generate-btn:hover {
        background: #ffd893;
        transform: translateY(-2px);
    }

    .modal-logout-btn {
        background: rgba(231, 76, 60, 0.2);
        color: var(--impostor-red);
        border: 1px solid var(--impostor-red);
    }

    .modal-logout-btn:hover {
        background: var(--impostor-red);
        color: white;
        transform: translateY(-2px);
    }

    /* Server Required Message */
    .server-required-message {
        background: rgba(255, 203, 116, 0.1);
        border: 2px solid var(--crewmate-yellow);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        text-align: center;
    }

    .server-invite-btn {
        background: var(--crewmate-yellow);
        color: var(--crewmate-yellow-text);
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 700;
        text-decoration: none;
        display: inline-block;
        margin-top: 0.5rem;
        transition: all 0.3s ease;
    }

    .server-invite-btn:hover {
        background: #ffd893;
        transform: translateY(-2px);
    }

    /* Status Indicator */
    .status-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding: 0.7rem;
        border-radius: 8px;
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--panel-border-color);
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-dot.online {
        background: var(--success-color);
    }

    .status-dot.offline {
        background: var(--error-color);
    }

    /* Responsive */
    @media (max-width: 520px) {
        body { padding: 1rem 0.5rem; } 
        .container { 
            width: 100%; padding: 1.2rem;
            margin-top: 0.5rem; margin-bottom: 0.5rem; 
        }
        .main-header {
            flex-direction: column;
            gap: 1rem;
        }
        .user-profile-header {
            width: 100%;
            justify-content: center;
        }
        .user-info-header {
            align-items: center;
        }
        header h1 { font-size: 1.6em; }
        .key-value { font-size: 1.1em; }
        .keys-list-section ul { max-height: 160px; }
        .controls-section {
            flex-direction: column;
            gap: 0.5rem;
        }
        .achievement-popup {
            top: 10px;
            right: 10px;
            left: 10px;
            transform: translateY(-100px);
        }
        .achievement-popup.show {
            transform: translateY(0);
        }
        .key-limit-info {
            font-size: 0.9rem;
        }
        .discord-widget {
            width: 100%;
            height: 400px;
        }
        .discord-widget-container {
            width: 95%;
            padding: 1rem;
        }
        .bottom-buttons {
            gap: 0.5rem;
        }
        .modal-stats {
            grid-template-columns: 1fr;
            padding: 1.5rem;
        }
        .modal-header {
            padding: 1.5rem;
            flex-direction: column;
            text-align: center;
        }
        .modal-actions {
            flex-direction: column;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }
    }
  </style>
</head>
<body>
  <div id="starfield"></div> 
  <div class="scanline-overlay"></div>
  
  <!-- Header com perfil do usu√°rio no canto superior direito -->
  <div class="main-header">
    <div class="header-content">
      <header>
        <h1>Terminal de Acesso - MIRA HQ</h1>
        <p class="subtitle">üßë‚ÄçüöÄ Tripulante, requisite sua Identifica√ß√£o de Acesso ou verifique os registros do ciclo atual. Mantenha-se alerta!</p>
      </header>
    </div>
    
    <!-- Perfil do usu√°rio no canto superior direito -->
    <div id="userProfileHeader" class="user-profile-header" style="display: none;">
      <img id="userAvatarHeader" src="" alt="Avatar" class="user-avatar-header">
      <div class="user-info-header">
        <span id="userNameHeader" class="username-header"></span>
        <span id="userDiscriminatorHeader" class="discriminator-header"></span>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- Status Indicator -->
    <div class="status-indicator">
      <div class="status-dot online"></div>
      <span>Sistema MIRA HQ Online</span>
    </div>

    <!-- Discord Auth Section - Simplificada -->
    <section id="authSection" class="auth-section">
        <button id="discordAuthBtn" class="discord-auth-btn">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE4LjU0IDcuNzZMMTcuMDggMTkuMkwxMiA5LjY4TDYuOTIgMTkuMkw1LjQ2IDcuNzZMMTIgNS4xTDE4LjU0IDcuNzZaIiBmaWxsPSIjNTg2NUYyIi8+Cjwvc3ZnPg==" alt="Discord">
            üéÆ Entrar com Discord
        </button>
    </section>

    <!-- User Profile Modal -->
    <div id="userProfileModal" class="modal">
        <div class="modal-content profile-modal">
            <span class="close-modal">&times;</span>
            
            <div class="modal-header">
                <img id="modalUserAvatar" src="" alt="Avatar" class="modal-avatar">
                <div class="modal-user-info">
                    <h3 id="modalUserName"></h3>
                    <p id="modalUserDiscriminator" class="user-handle"></p>
                    <div id="modalServerStatus" class="server-badge"></div>
                </div>
            </div>

            <div class="modal-stats">
                <div class="stat-card">
                    <div class="stat-icon">üîë</div>
                    <div class="stat-info">
                        <span class="stat-value" id="statKeysToday">0</span>
                        <span class="stat-label">Keys Hoje</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-info">
                        <span class="stat-value" id="statTotalKeys">0</span>
                        <span class="stat-label">Total Keys</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <span class="stat-value" id="statActiveKeys">0</span>
                        <span class="stat-label">Keys Ativas</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üïí</div>
                    <div class="stat-info">
                        <span class="stat-value" id="statMemberSince">Agora</span>
                        <span class="stat-label">Membro desde</span>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button id="modalGenerateBtn" class="modal-action-btn generate-btn">
                    üöÄ Gerar Nova Key
                </button>
                <button id="modalLogoutBtn" class="modal-action-btn modal-logout-btn">
                    üö™ Sair
                </button>
            </div>
        </div>
    </div>

    <div class="controls-section">
      <button class="control-button" id="soundToggle" title="Alternar efeitos sonoros">
        üîä
      </button>
    </div>

    <div class="cooldown-section" id="cooldownSection" style="display: none;">
      <div class="cooldown-timer">
        <div>‚ö†Ô∏è SISTEMA EM COOLDOWN</div>
        <div id="cooldownTime">30s</div>
        <div style="font-size: 0.8em; margin-top: 0.5rem;">Aguarde para nova solicita√ß√£o</div>
      </div>
    </div>

    <div class="key-limit-section" id="keyLimitSection" style="display: none;">
      <div class="key-limit-info" id="keyLimitInfo">
        <div id="keyLimitText">Voc√™ possui 0 IDs ativas (m√°ximo: 5 por tripulante)</div>
        <div style="font-size: 0.85em; margin-top: 0.5rem;" id="keyLimitHelper">üí° Use suas IDs no mod Among Us para liberar espa√ßo</div>
      </div>
    </div>
    
    <div class="button-group">
      <button id="generateBtn" title="Requisitar nova ID de Acesso via verifica√ß√£o">
        <span class="button-text">‚ö†Ô∏è INICIAR TASK: REGISTRO</span>
        <span class="spinner"></span>
      </button>
      <button id="viewKeysBtn" title="Consultar IDs de Tripulantes Ativos">
        <span class="button-text">üõ∞Ô∏è LOG DE SISTEMA</span>
        <span class="spinner"></span>
      </button>
    </div>
    
    <section class="key-display-area">
      <div class="key-container" id="keyContainer"> 
        <div class="key-value-label">ID de Tripulante Designada:</div>
        <div class="key-value" id="keyValue"></div>
        <div class="key-actions" id="keyActions" style="display: none;">
          <button class="copy-button" id="copyButton">
            üìã Copiar ID
          </button>
        </div>
        <div class="key-metadata" id="keyMetadata" style="display: none;">
          <div>üìÖ Gerada em: <span id="keyTimestamp"></span></div>
          <div>üîë Tipo: Acesso MIRA HQ</div>
          <div>‚è±Ô∏è Status: Ativa</div>
        </div>
        <div class="progress-bar" id="progressBar" style="display: none;">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
    </section>
    
    <section class="message-area">
      <div class="message" id="message"></div>
    </section>
    
    <section class="keys-list-section">
      <h2>Registros de IDs - Ciclo Atual</h2>
      <ul id="keysList">
      </ul>
    </section>

    <div class="bottom-buttons">
      <button class="support-button" id="supportButton">
        üÜò Suporte
      </button>

      <button class="translate-button" id="translateButton">
        üåê Traduzir P√°gina
      </button>
    </div>
  </main>

  <div class="overlay" id="overlay"></div>

  <div class="discord-widget-container" id="discordWidgetContainer">
    <div class="discord-widget-header">
      <h3 class="discord-widget-title">Suporte - Discord</h3>
      <button class="close-widget" id="closeWidget">&times;</button>
    </div>
    <div class="discord-widget">
      <iframe src="https://discord.com/widget?id=1372893306727563284&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
    </div>
  </div>

  <div class="achievement-popup" id="achievementPopup"></div>

  <script>
    // ==================== CONFIGURA√á√ÉO ====================
    const CONFIG = {
      API_BASE_URL: 'https://keygen2.onrender.com',
      SHORTENER_URL: 'https://link-target.net/63830/dfTOvKegYIZo',
      MAX_KEY_LIMIT: 5,
      COOLDOWN_DURATION: 30000,
      BACKEND_VERIFICATION_TOKEN_KEY: 'miraHqBackendVerificationToken',
      RETURN_ACTION_PARAM: 'action',
      RETURN_ACTION_VALUE: 'generate_from_shortener',
      RETURN_STATUS_PARAM: 'status',
      RETURN_STATUS_VALUE: 'completed'
    };

    // ==================== ELEMENTOS DOM ====================
    const elements = {
      btnGen: document.getElementById('generateBtn'),
      btnView: document.getElementById('viewKeysBtn'),
      keyContainerEl: document.getElementById('keyContainer'),
      keyValueEl: document.getElementById('keyValue'),
      messageEl: document.getElementById('message'),
      keysListUl: document.getElementById('keysList'),
      starfield: document.getElementById('starfield'),
      soundToggle: document.getElementById('soundToggle'),
      copyButton: document.getElementById('copyButton'),
      keyActions: document.getElementById('keyActions'),
      keyMetadata: document.getElementById('keyMetadata'),
      keyTimestamp: document.getElementById('keyTimestamp'),
      cooldownSection: document.getElementById('cooldownSection'),
      cooldownTime: document.getElementById('cooldownTime'),
      progressBar: document.getElementById('progressBar'),
      progressFill: document.getElementById('progressFill'),
      achievementPopup: document.getElementById('achievementPopup'),
      keyLimitSection: document.getElementById('keyLimitSection'),
      keyLimitInfo: document.getElementById('keyLimitInfo'),
      keyLimitText: document.getElementById('keyLimitText'),
      keyLimitHelper: document.getElementById('keyLimitHelper'),
      translateButton: document.getElementById('translateButton'),
      supportButton: document.getElementById('supportButton'),
      discordWidgetContainer: document.getElementById('discordWidgetContainer'),
      overlay: document.getElementById('overlay'),
      closeWidget: document.getElementById('closeWidget'),
      discordAuthBtn: document.getElementById('discordAuthBtn'),
      userProfileModal: document.getElementById('userProfileModal'),
      modalUserAvatar: document.getElementById('modalUserAvatar'),
      modalUserName: document.getElementById('modalUserName'),
      modalUserDiscriminator: document.getElementById('modalUserDiscriminator'),
      modalServerStatus: document.getElementById('modalServerStatus'),
      statKeysToday: document.getElementById('statKeysToday'),
      statTotalKeys: document.getElementById('statTotalKeys'),
      statActiveKeys: document.getElementById('statActiveKeys'),
      statMemberSince: document.getElementById('statMemberSince'),
      modalGenerateBtn: document.getElementById('modalGenerateBtn'),
      modalLogoutBtn: document.getElementById('modalLogoutBtn'),
      // Novos elementos para o header
      userProfileHeader: document.getElementById('userProfileHeader'),
      userAvatarHeader: document.getElementById('userAvatarHeader'),
      userNameHeader: document.getElementById('userNameHeader'),
      userDiscriminatorHeader: document.getElementById('userDiscriminatorHeader'),
      authSection: document.getElementById('authSection')
    };

    // ==================== ESTADO DA APLICA√á√ÉO ====================
    const appState = {
      userKeys: [],
      soundEnabled: false,
      cooldownTimer: null,
      keyGenerationCount: 0,
      lastKeyGenerationTime: 0,
      isInCooldown: false,
      audioContext: null,
      isProcessing: false,
      isTranslated: false
    };

    // ==================== SISTEMA DE AUTENTICA√á√ÉO DISCORD ====================
    class DiscordAuthSystem {
      constructor() {
        this.sessionId = localStorage.getItem('crewbot_session');
        this.userData = JSON.parse(localStorage.getItem('crewbot_user') || 'null');
        this.userStats = JSON.parse(localStorage.getItem('crewbot_stats') || 'null');
        this.isAuthenticated = !!this.sessionId;
        this.sessionExpiresAt = parseInt(localStorage.getItem('crewbot_session_expires') || '0');
      }

      async init() {
        this.setupEventListeners();
        this.setupModal();
        
        // Verificar se a sess√£o est√° expirada
        if (this.isSessionExpired()) {
          await this.logout();
          this.updateUI();
        } else if (this.sessionId) {
          // Tentar validar a sess√£o existente
          const isValid = await this.validateSession();
          if (isValid) {
            await this.loadUserStats();
          } else {
            // Tentar refresh da sess√£o
            await this.refreshSession();
          }
        }
        
        this.updateUI();
        this.handleCallbackFromURL();
      }

      isSessionExpired() {
        return Date.now() > this.sessionExpiresAt;
      }

      async refreshSession() {
        if (!this.sessionId) return false;
        
        try {
          const response = await fetch(`${CONFIG.API_BASE_URL}/auth/refresh`, {
            method: 'POST',
            headers: { 'X-Session-ID': this.sessionId }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
              this.userData = data.user;
              this.sessionExpiresAt = data.session_expires_at;
              localStorage.setItem('crewbot_user', JSON.stringify(this.userData));
              localStorage.setItem('crewbot_session_expires', this.sessionExpiresAt.toString());
              return true;
            }
          }
        } catch (error) {
          console.error('Erro ao refresh session:', error);
        }
        
        return false;
      }

      setupEventListeners() {
        if (elements.discordAuthBtn) {
          elements.discordAuthBtn.addEventListener('click', () => this.startAuth());
        }
        // Novo listener para o header
        if (elements.userProfileHeader) {
          elements.userProfileHeader.addEventListener('click', () => this.showUserModal());
        }
      }

      setupModal() {
        const closeBtn = document.querySelector('.close-modal');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => this.hideUserModal());
        }

        if (elements.userProfileModal) {
          elements.userProfileModal.addEventListener('click', (e) => {
            if (e.target === elements.userProfileModal) this.hideUserModal();
          });
        }

        if (elements.modalGenerateBtn) {
          elements.modalGenerateBtn.addEventListener('click', () => {
            this.hideUserModal();
            initiateShortenerRedirect();
          });
        }

        if (elements.modalLogoutBtn) {
          elements.modalLogoutBtn.addEventListener('click', () => {
            this.hideUserModal();
            this.logout();
          });
        }

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && elements.userProfileModal.style.display === 'block') {
            this.hideUserModal();
          }
        });
      }

      async startAuth() {
        try {
          showUIMessage('üîÑ Conectando com Discord...', 'info');
          const response = await fetch(`${CONFIG.API_BASE_URL}/auth/discord`);
          const data = await response.json();
          
          if (data.status === 'success') {
            window.location.href = data.auth_url;
          }
        } catch (error) {
          showUIMessage('‚ùå Erro ao conectar com Discord', 'error');
        }
      }

      async handleCallbackFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');

        if (code && state) {
          try {
            showUIMessage('üîê Verificando autentica√ß√£o...', 'info');
            const response = await fetch(`${CONFIG.API_BASE_URL}/auth/discord/callback`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code, state })
            });

            const data = await response.json();

            if (data.status === 'success') {
              await this.handleAuthSuccess(data);
            } else if (data.status === 'server_required') {
              this.handleServerRequired(data);
            }

            window.history.replaceState({}, document.title, window.location.pathname);
          } catch (error) {
            showUIMessage('‚ùå Falha na autentica√ß√£o', 'error');
          }
        }
      }

      async handleAuthSuccess(data) {
        this.sessionId = data.session_id;
        this.userData = data.user;
        this.isAuthenticated = true;
        this.sessionExpiresAt = Date.now() + (24 * 60 * 60 * 1000); // 24 horas

        localStorage.setItem('crewbot_session', this.sessionId);
        localStorage.setItem('crewbot_user', JSON.stringify(this.userData));
        localStorage.setItem('crewbot_session_expires', this.sessionExpiresAt.toString());

        await this.loadUserStats();
        this.updateUI();
        showUIMessage(data.message, 'success');

        if (appState.soundEnabled) {
          playSoundSequence([
            {freq: 523, duration: 100, type: 'sine'},
            {freq: 659, duration: 100, type: 'sine'},
            {freq: 784, duration: 200, type: 'sine'}
          ]);
        }

        await fetchUserKeyList();
      }

      handleServerRequired(data) {
        showUIMessage(data.message, 'error', 10000);
        
        const serverRequiredHTML = `
          <div class="server-required-message">
            <p>üéÆ Voc√™ precisa entrar no nosso servidor Discord para gerar keys!</p>
            <a href="${data.discord_invite}" target="_blank" class="server-invite-btn">
              üöÄ Entrar no Servidor Crewbot
            </a>
            <p style="margin-top: 0.5rem; font-size: 0.9em; color: var(--text-color-medium);">
              Depois de entrar, atualize a p√°gina e fa√ßa login novamente.
            </p>
          </div>
        `;
        
        elements.authSection.innerHTML = serverRequiredHTML;
      }

      async validateSession() {
        if (!this.sessionId) return false;
        
        try {
          const response = await fetch(`${CONFIG.API_BASE_URL}/auth/me`, {
            headers: { 'X-Session-ID': this.sessionId }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
              this.userData = data.user;
              this.sessionExpiresAt = data.session_expires_at;
              localStorage.setItem('crewbot_user', JSON.stringify(this.userData));
              localStorage.setItem('crewbot_session_expires', this.sessionExpiresAt.toString());
              this.updateUI();
              return true;
            }
          }
        } catch (error) {
          console.error('Erro ao validar sess√£o:', error);
        }
        
        return false;
      }

      async loadUserStats() {
        if (!this.sessionId) return;
        
        try {
          const response = await fetch(`${CONFIG.API_BASE_URL}/auth/user-stats`, {
            headers: { 'X-Session-ID': this.sessionId }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
              this.userStats = data.stats;
              localStorage.setItem('crewbot_stats', JSON.stringify(this.userStats));
              this.updateModal();
            }
          }
        } catch (error) {
          console.error('Erro ao carregar estat√≠sticas:', error);
        }
      }

      showUserModal() {
        if (elements.userProfileModal) {
          this.updateModal();
          elements.userProfileModal.style.display = 'block';
          
          if (appState.soundEnabled) {
            playSound(600, 100, 'sine');
          }
        }
      }

      hideUserModal() {
        if (elements.userProfileModal) {
          elements.userProfileModal.style.display = 'none';
        }
      }

      updateModal() {
        if (!this.userData || !this.userStats) return;

        // Use a fun√ß√£o corrigida para obter o avatar
        const avatarUrl = this.getAvatarUrl(this.userData.id, this.userData.avatar, 128);
        
        elements.modalUserAvatar.src = avatarUrl;
        elements.modalUserName.textContent = this.userData.global_name || this.userData.username;
        elements.modalUserDiscriminator.textContent = `@${this.userData.username}`;

        if (this.userStats.is_server_member) {
          elements.modalServerStatus.textContent = '‚úÖ NO SERVIDOR';
          elements.modalServerStatus.className = 'server-badge verified';
        } else {
          elements.modalServerStatus.textContent = '‚ùå FORA DO SERVIDOR';
          elements.modalServerStatus.className = 'server-badge missing';
        }

        elements.statKeysToday.textContent = this.userStats.keys_today;
        elements.statTotalKeys.textContent = this.userStats.keys_total;
        elements.statActiveKeys.textContent = this.userStats.keys_active;
        
        const memberSince = new Date(this.userStats.member_since);
        const now = new Date();
        const diffTime = Math.abs(now - memberSince);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        let memberText = 'Hoje';
        if (diffDays === 1) memberText = '1 dia';
        else if (diffDays > 1) memberText = `${diffDays} dias`;
        
        elements.statMemberSince.textContent = memberText;

        if (this.userStats.is_server_member) {
          elements.modalGenerateBtn.disabled = false;
          elements.modalGenerateBtn.style.opacity = '1';
          elements.modalGenerateBtn.title = 'Gerar nova key';
        } else {
          elements.modalGenerateBtn.disabled = true;
          elements.modalGenerateBtn.style.opacity = '0.6';
          elements.modalGenerateBtn.title = 'Entre no servidor para gerar keys';
        }
      }

      async logout() {
        if (this.sessionId) {
          try {
            await fetch(`${CONFIG.API_BASE_URL}/auth/logout`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ session_id: this.sessionId })
            });
          } catch (error) {
            console.error('Erro no logout:', error);
          }
        }

        localStorage.removeItem('crewbot_session');
        localStorage.removeItem('crewbot_user');
        localStorage.removeItem('crewbot_stats');
        localStorage.removeItem('crewbot_session_expires');
        
        this.sessionId = null;
        this.userData = null;
        this.userStats = null;
        this.isAuthenticated = false;
        this.sessionExpiresAt = 0;

        this.updateUI();
        this.hideUserModal();
        showUIMessage('üëã Logout realizado com sucesso', 'info');

        await fetchUserKeyList();
      }

      // Adicione esta fun√ß√£o para corrigir o problema do avatar
      getAvatarUrl(userId, avatarHash, size = 64) {
        if (!avatarHash) {
          return `https://cdn.discordapp.com/embed/avatars/${userId % 5}.png`;
        }
        return `https://cdn.discordapp.com/avatars/${userId}/${avatarHash}.png?size=${size}`;
      }

      updateUI() {
        if (this.isAuthenticated && this.userData) {
          // Esconder a se√ß√£o de auth e mostrar o perfil no header
          elements.authSection.style.display = 'none';
          elements.userProfileHeader.style.display = 'flex';

          // Use a fun√ß√£o corrigida para obter o avatar
          const avatarUrl = this.getAvatarUrl(this.userData.id, this.userData.avatar, 40);

          elements.userAvatarHeader.src = avatarUrl;
          elements.userNameHeader.textContent = this.userData.global_name || this.userData.username;
          elements.userDiscriminatorHeader.textContent = `@${this.userData.username}`;

          const isServerMember = this.userStats ? this.userStats.is_server_member : this.userData.isServerMember;
          if (isServerMember) {
            this.updateGenerateButton(true);
          } else {
            this.updateGenerateButton(false);
          }

        } else {
          // Mostrar a se√ß√£o de auth e esconder o perfil no header
          elements.authSection.style.display = 'block';
          elements.userProfileHeader.style.display = 'none';
          this.updateGenerateButton(false);
        }
      }

      updateGenerateButton(isServerMember) {
        if (!elements.btnGen) return;

        if (isServerMember && this.isAuthenticated) {
          elements.btnGen.disabled = false;
          elements.btnGen.title = 'Gerar nova ID de Acesso';
          elements.btnGen.innerHTML = '<span class="button-text">‚ö†Ô∏è INICIAR TASK: REGISTRO</span><span class="spinner"></span>';
        } else {
          elements.btnGen.disabled = true;
          if (!this.isAuthenticated) {
            elements.btnGen.title = 'Fa√ßa login com Discord para gerar keys';
            elements.btnGen.innerHTML = '<span class="button-text">üîê LOGIN REQUERIDO</span><span class="spinner"></span>';
          } else {
            elements.btnGen.title = 'Entre no servidor Discord para gerar keys';
            elements.btnGen.innerHTML = '<span class="button-text">üéÆ SERVIDOR N√ÉO VERIFICADO</span><span class="spinner"></span>';
          }
        }
      }

      getAuthHeaders() {
        return this.sessionId ? { 'X-Session-ID': this.sessionId } : {};
      }

      async refreshStats() {
        await this.loadUserStats();
        this.updateUI();
        this.updateModal();
      }
    }

    const discordAuth = new DiscordAuthSystem();

    // ==================== FUN√á√ïES UTILIT√ÅRIAS ====================
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/[<>'"&]/g, function(match) {
        const entityMap = {
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '&': '&amp;'
        };
        return entityMap[match];
      });
    }

    function validateKey(key) {
      return typeof key === 'string' && /^[A-Z0-9-]{19}$/.test(key);
    }

    function validateToken(token) {
      return typeof token === 'string' && /^[a-zA-Z0-9\-_]{20,}$/.test(token);
    }

    // ==================== √ÅUDIO ====================
    function initAudioContext() {
      if (!appState.audioContext && appState.soundEnabled) {
        try {
          appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch {}
      }
    }

    function playSound(frequency, duration = 100, type = 'sine') {
      if (!appState.soundEnabled || !appState.audioContext || frequency < 80 || frequency > 2000) return;
      
      try {
        const oscillator = appState.audioContext.createOscillator();
        const gainNode = appState.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(appState.audioContext.destination);
        
        oscillator.frequency.value = Math.max(80, Math.min(2000, frequency));
        oscillator.type = ['sine', 'square', 'sawtooth', 'triangle'].includes(type) ? type : 'sine';
        
        gainNode.gain.setValueAtTime(0.1, appState.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, appState.audioContext.currentTime + Math.min(1000, duration) / 1000);
        
        oscillator.start(appState.audioContext.currentTime);
        oscillator.stop(appState.audioContext.currentTime + Math.min(1000, duration) / 1000);
      } catch {}
    }

    function playSoundSequence(sequence) {
      if (!appState.soundEnabled || !Array.isArray(sequence)) return;
      sequence.slice(0, 10).forEach((note, index) => {
        if (note && typeof note.freq === 'number') {
          setTimeout(() => playSound(note.freq, note.duration, note.type), index * 150);
        }
      });
    }

    function updateSoundToggle() {
      if (elements.soundToggle) {
        elements.soundToggle.textContent = appState.soundEnabled ? 'üîä' : 'üîá';
        elements.soundToggle.classList.toggle('active', appState.soundEnabled);
        localStorage.setItem('soundEnabled', appState.soundEnabled.toString());
      }
    }

    // ==================== UI FUNCTIONS ====================
    function setButtonLoading(button, isLoading) {
      if (!button) return;
      button.classList.toggle('loading', isLoading);
      button.disabled = isLoading;
    }

    function showUIMessage(text, type = 'info', duration = 4500) {
      if (!elements.messageEl || typeof text !== 'string') return;
      
      elements.messageEl.textContent = sanitizeInput(text.slice(0, 200));
      elements.messageEl.className = `message visible ${['info', 'success', 'error'].includes(type) ? type : 'info'}`; 
      
      if (elements.messageEl.timeoutId) clearTimeout(elements.messageEl.timeoutId);
      if (duration > 0) {
        elements.messageEl.timeoutId = setTimeout(() => {
          if (elements.messageEl) elements.messageEl.className = 'message'; 
        }, Math.min(10000, duration));
      }
    }

    function updateProgress(percent) {
      if (!elements.progressBar || !elements.progressFill) return;
      
      const safePercent = Math.max(0, Math.min(100, percent));
      elements.progressBar.style.display = 'block';
      elements.progressFill.style.width = `${safePercent}%`;
      
      if (safePercent >= 100) {
        setTimeout(() => {
          if (elements.progressBar && elements.progressFill) {
            elements.progressBar.style.display = 'none';
            elements.progressFill.style.width = '0%';
          }
        }, 1000);
      }
    }

    function updateKeyLimitDisplay() {
      if (!elements.keyLimitSection || !elements.keyLimitText || !elements.keyLimitHelper) return;
      
      const keysUsed = Math.max(0, Math.min(CONFIG.MAX_KEY_LIMIT, appState.userKeys.length));
      const remainingKeys = CONFIG.MAX_KEY_LIMIT - keysUsed;
      
      elements.keyLimitText.textContent = `Voc√™ possui ${keysUsed} ID${keysUsed !== 1 ? 's' : ''} ativa${keysUsed !== 1 ? 's' : ''} (m√°ximo: ${CONFIG.MAX_KEY_LIMIT} por tripulante)`;
      
      if (remainingKeys === 0) {
        elements.keyLimitInfo.className = 'key-limit-info key-limit-full';
        elements.keyLimitHelper.textContent = '‚ö†Ô∏è Limite atingido! Use suas IDs ativas no mod Among Us para validar e liberar espa√ßo para novas IDs';
        elements.keyLimitSection.style.display = 'block';
      } else if (remainingKeys <= 2) {
        elements.keyLimitInfo.className = 'key-limit-info key-limit-warning';
        elements.keyLimitHelper.textContent = `‚ö° ${remainingKeys} slot${remainingKeys !== 1 ? 's' : ''} restante${remainingKeys !== 1 ? 's' : ''}! Use suas IDs no mod Among Us para validar e liberar espa√ßo`;
        elements.keyLimitSection.style.display = 'block';
      } else if (remainingKeys < CONFIG.MAX_KEY_LIMIT) {
        elements.keyLimitInfo.className = 'key-limit-info';
        elements.keyLimitHelper.textContent = `‚úÖ ${remainingKeys} slots dispon√≠veis - Use suas IDs no mod Among Us para validar e liberar espa√ßo automaticamente`;
        elements.keyLimitSection.style.display = 'block';
      } else {
        elements.keyLimitSection.style.display = 'none';
      }
    }

    function renderKeysList() {
      if (!elements.keysListUl) return;
      
      elements.keysListUl.innerHTML = ''; 
      
      if (!Array.isArray(appState.userKeys) || appState.userKeys.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'Nenhum registro de ID neste terminal para o ciclo atual.';
        li.classList.add('no-keys'); 
        elements.keysListUl.appendChild(li);
        return;
      }
      
      appState.userKeys.slice(0, CONFIG.MAX_KEY_LIMIT).forEach(key => {
        if (validateKey(key)) {
          const li = document.createElement('li');
          li.textContent = sanitizeInput(key);
          elements.keysListUl.appendChild(li);
        }
      });
    }

    async function copyToClipboard() {
      if (!elements.keyValueEl) return;
      
      const keyValue = elements.keyValueEl.textContent;
      if (!keyValue || keyValue.includes('AUTENTICANDO') || !validateKey(keyValue)) return;
      
      try {
        await navigator.clipboard.writeText(keyValue);
        if (elements.copyButton) {
          elements.copyButton.textContent = '‚úÖ Copiado!';
          elements.copyButton.classList.add('copied');
        }
        
        if (appState.soundEnabled) {
          playSoundSequence([
            {freq: 800, duration: 100, type: 'sine'},
            {freq: 1000, duration: 150, type: 'sine'}
          ]);
        }
        
        setTimeout(() => {
          if (elements.copyButton) {
            elements.copyButton.textContent = 'üìã Copiar ID';
            elements.copyButton.classList.remove('copied');
          }
        }, 2000);
      } catch (err) {
        showUIMessage('‚ùå Erro ao copiar. Tente selecionar manualmente.', 'error', 3000);
        if (appState.soundEnabled) playSound(200, 200, 'sawtooth');
      }
    }

    function showAchievement(text) {
      if (!elements.achievementPopup || typeof text !== 'string') return;
      elements.achievementPopup.textContent = `üèÜ ${sanitizeInput(text.slice(0, 100))}`;
      elements.achievementPopup.classList.add('show');
      setTimeout(() => {
        elements.achievementPopup.classList.remove('show');
      }, 3000);
    }

    // ==================== COOLDOWN SYSTEM ====================
    function checkCooldownOnLoad() {
      const now = Date.now();
      const timeSinceLastGeneration = now - appState.lastKeyGenerationTime;

      if (timeSinceLastGeneration < CONFIG.COOLDOWN_DURATION && timeSinceLastGeneration > 0) {
        const remainingCooldown = Math.ceil((CONFIG.COOLDOWN_DURATION - timeSinceLastGeneration) / 1000);
        if (remainingCooldown > 0 && remainingCooldown <= 30) {
          startCooldown(remainingCooldown);
        }
      }
    }

    function startCooldown(seconds = 30) {
      if (appState.cooldownTimer) {
        clearInterval(appState.cooldownTimer);
      }
      
      appState.isInCooldown = true;
      if (elements.cooldownSection) elements.cooldownSection.style.display = 'block';
      if (elements.btnGen) {
        elements.btnGen.disabled = true;
        elements.btnGen.style.opacity = '0.5';
        elements.btnGen.style.cursor = 'not-allowed';
      }
      
      let remaining = Math.max(0, Math.min(60, Math.floor(seconds)));
      if (elements.cooldownTime) elements.cooldownTime.textContent = `${remaining}s`;
      
      appState.cooldownTimer = setInterval(() => {
        remaining--;
        if (elements.cooldownTime) elements.cooldownTime.textContent = `${remaining}s`;
        
        if (remaining <= 0) {
          clearInterval(appState.cooldownTimer);
          appState.cooldownTimer = null;
          appState.isInCooldown = false;
          
          if (elements.cooldownSection) elements.cooldownSection.style.display = 'none';
          if (elements.btnGen) {
            elements.btnGen.disabled = false;
            elements.btnGen.style.opacity = '1';
            elements.btnGen.style.cursor = 'pointer';
          }
          
          if (appState.soundEnabled) {
            playSoundSequence([
              {freq: 440, duration: 100, type: 'sine'},
              {freq: 554, duration: 100, type: 'sine'},
              {freq: 659, duration: 200, type: 'sine'}
            ]);
          }
          showUIMessage('‚úÖ Sistema pronto para nova solicita√ß√£o!', 'success', 3000);
        }
      }, 1000);
    }

    // ==================== KEY GENERATION ====================
    async function generateNewKey() {
      if (appState.isProcessing) return;
      appState.isProcessing = true;
      
      try {
        initAudioContext();
        
        if (appState.soundEnabled) {
          playSoundSequence([
            {freq: 800, duration: 100, type: 'square'},
            {freq: 600, duration: 100, type: 'square'},
            {freq: 400, duration: 150, type: 'square'}
          ]);
        }

        setButtonLoading(elements.btnGen, true); 
        if (elements.keyContainerEl) elements.keyContainerEl.classList.remove('visible'); 
        if (elements.keyActions) elements.keyActions.style.display = 'none';
        if (elements.keyMetadata) elements.keyMetadata.style.display = 'none';
        if (elements.keyValueEl) {
          elements.keyValueEl.textContent = 'AUTENTICANDO NO SISTEMA MIRA HQ...'; 
          elements.keyValueEl.classList.add('processing');
        }
        updateProgress(10);
        
        const verificationToken = localStorage.getItem(CONFIG.BACKEND_VERIFICATION_TOKEN_KEY);
        if (!verificationToken || !validateToken(verificationToken)) {
          showUIMessage('‚ùå Falha na verifica√ß√£o de seguran√ßa. Tente o processo novamente.', 'error', 6000);
          if (elements.keyValueEl) {
            elements.keyValueEl.textContent = '';
            elements.keyValueEl.classList.remove('processing');
          }
          if (appState.soundEnabled) playSound(200, 300, 'sawtooth');
          return;
        }

        showUIMessage('üõ∞Ô∏è Link com Servidor Central MIRA HQ...', 'info', 0); 
        updateProgress(30);

        const headers = {
          'X-Verification-Token': verificationToken,
          ...discordAuth.getAuthHeaders()
        };

        const response = await fetch(`${CONFIG.API_BASE_URL}/generate_key`, {
          method: 'GET',
          headers: headers
        });
        
        updateProgress(70);
        const data = await response.json(); 
        if (elements.keyValueEl) elements.keyValueEl.classList.remove('processing');
        localStorage.removeItem(CONFIG.BACKEND_VERIFICATION_TOKEN_KEY); 

        if (response.ok && data.status === 'success' && data.key && validateKey(data.key)) {
          updateProgress(100);
          if (elements.keyValueEl) elements.keyValueEl.textContent = sanitizeInput(data.key);
          if (elements.keyContainerEl) elements.keyContainerEl.classList.add('visible');
          if (elements.keyActions) elements.keyActions.style.display = 'flex';
          if (elements.keyMetadata) elements.keyMetadata.style.display = 'block';
          if (elements.keyTimestamp) elements.keyTimestamp.textContent = new Date().toLocaleString('pt-BR');
          
          appState.keyGenerationCount++;
          appState.lastKeyGenerationTime = Date.now();
          localStorage.setItem('keyGenerationCount', appState.keyGenerationCount.toString());
          localStorage.setItem('lastKeyGenerationTime', appState.lastKeyGenerationTime.toString());
          
          if (appState.soundEnabled) {
            playSoundSequence([
              {freq: 523, duration: 150, type: 'sine'},
              {freq: 659, duration: 150, type: 'sine'},
              {freq: 784, duration: 200, type: 'sine'},
              {freq: 1047, duration: 250, type: 'sine'}
            ]);
          }
          
          showUIMessage('‚úÖ ID de Acesso V√°lida! Prossiga com suas tarefas, Tripulante.', 'success');
          
          if (appState.keyGenerationCount === 1) {
            showAchievement('Primeiro Acesso - Bem-vindo √† MIRA HQ!');
          } else if (appState.keyGenerationCount === 5) {
            showAchievement('Tripulante Veterano - 5 IDs geradas!');
          } else if (appState.keyGenerationCount === 10) {
            showAchievement('Especialista em Seguran√ßa - 10 IDs!');
          }
          
          await fetchUserKeyList();
          await discordAuth.refreshStats();
          startCooldown(30);
        } else {
          let errorMessage = 'ERRO DE PROTOCOLO: Solicita√ß√£o de ID Negada.';
          if (data && typeof data.message === 'string') {
            errorMessage = sanitizeInput(data.message.slice(0, 100));
          }
          
          if (response.status === 403) { 
            errorMessage = `‚ùå Falha na verifica√ß√£o: ${errorMessage}`;
          } else if (response.status === 429) {
            errorMessage = '‚ö†Ô∏è ALERTA: Limite de requisi√ß√µes de ID atingido. Aguarde o pr√≥ximo ciclo.';
            if (data.message && data.message.includes('5 chaves')) {
              startCooldown(60);
            }
          }
          showUIMessage(errorMessage, 'error', 6000);
          if (elements.keyContainerEl) elements.keyContainerEl.classList.remove('visible');
          if (appState.soundEnabled) playSound(200, 500, 'sawtooth');
        }
      } catch (error) {
        if (elements.keyValueEl) elements.keyValueEl.classList.remove('processing');
        localStorage.removeItem(CONFIG.BACKEND_VERIFICATION_TOKEN_KEY);
        showUIMessage('üö´ EMERG√äNCIA: Perda de comunica√ß√£o com o servidor. Poss√≠vel sabotagem!', 'error', 6000);
        if (elements.keyContainerEl) elements.keyContainerEl.classList.remove('visible');
        if (appState.soundEnabled) playSound(150, 800, 'sawtooth');
      } finally {
        setButtonLoading(elements.btnGen, false);
        appState.isProcessing = false;
      }
    }

    async function fetchUserKeyList() {
      try {
        setButtonLoading(elements.btnView, true);
        showUIMessage('Consultando Log de IDs do sistema...', 'info', 0);

        const headers = discordAuth.getAuthHeaders();
        const response = await fetch(`${CONFIG.API_BASE_URL}/user_keys`, { headers });
        const data = await response.json();

        if (response.ok && data.status === 'success') {
          appState.userKeys = Array.isArray(data.keys) ? data.keys.filter(key => validateKey(key)).slice(0, CONFIG.MAX_KEY_LIMIT) : [];
          renderKeysList();
          updateKeyLimitDisplay();
          showUIMessage(appState.userKeys.length > 0 ? 'Relat√≥rio de IDs carregado.' : 'Nenhuma ID encontrada no log.', 'info', 3000);
        } else {
          const errorMessage = (data && typeof data.message === 'string') ? sanitizeInput(data.message.slice(0, 100)) : `FALHA DE SISTEMA ${response.status}: Imposs√≠vel acessar registros.`;
          showUIMessage(`‚ùå ${errorMessage}`, 'error');
        }
      } catch (error) {
        showUIMessage('üö´ Falha de comunica√ß√£o ao acessar registros. Tente novamente.', 'error', 6000);
      } finally {
        setButtonLoading(elements.btnView, false);
      }
    }

    // ==================== SHORTENER SYSTEM ====================
    async function initiateShortenerRedirect() {
      if (appState.isInCooldown || (elements.btnGen && elements.btnGen.disabled) || appState.isProcessing) {
        showUIMessage('‚è±Ô∏è AGUARDE: Sistema em cooldown. Aguarde o tempo restante antes de fazer nova solicita√ß√£o.', 'error', 4000);
        if (appState.soundEnabled) playSound(200, 300, 'sawtooth');
        return;
      }

      if (appState.userKeys.length >= CONFIG.MAX_KEY_LIMIT) {
        showUIMessage('‚ö†Ô∏è LIMITE ATINGIDO: Voc√™ possui o m√°ximo de 5 IDs. Use uma ID no mod Among Us para liberar espa√ßo antes de gerar nova.', 'error', 6000);
        if (appState.soundEnabled) playSound(200, 500, 'sawtooth');
        return;
      }

      appState.isProcessing = true;
      
      try {
        if (appState.soundEnabled) playSound(600, 100, 'square');
        setButtonLoading(elements.btnGen, true);
        showUIMessage('‚è≥ Iniciando verifica√ß√£o de seguran√ßa...', 'info', 0);

        const response = await fetch(`${CONFIG.API_BASE_URL}/initiate-verification`, {
          method: 'GET'
        });
        const data = await response.json();

        if (response.ok && data.status === 'success' && data.verification_token && validateToken(data.verification_token)) {
          localStorage.setItem(CONFIG.BACKEND_VERIFICATION_TOKEN_KEY, data.verification_token);
          showUIMessage('‚è≥ Preparando redirecionamento para o portal...', 'info', 5000);
          
          setTimeout(() => {
            window.location.href = CONFIG.SHORTENER_URL;
          }, 1500);
        } else {
          const errorMessage = (data && typeof data.message === 'string') ? sanitizeInput(data.message.slice(0, 100)) : 'Erro desconhecido.';
          showUIMessage(`‚ùå Falha ao iniciar verifica√ß√£o: ${errorMessage}`, 'error', 6000);
          setButtonLoading(elements.btnGen, false);
          appState.isProcessing = false;
        }
      } catch (error) {
        showUIMessage('üö´ Falha de comunica√ß√£o ao iniciar verifica√ß√£o. Tente novamente.', 'error', 6000);
        setButtonLoading(elements.btnGen, false);
        appState.isProcessing = false;
      }
    }

    function checkAndProcessShortenerReturn() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const action = sanitizeInput(urlParams.get(CONFIG.RETURN_ACTION_PARAM) || '');
        const status = sanitizeInput(urlParams.get(CONFIG.RETURN_STATUS_PARAM) || '');

        const actionMatches = action === CONFIG.RETURN_ACTION_VALUE;
        const statusMatches = status === CONFIG.RETURN_STATUS_VALUE;
        const backendToken = localStorage.getItem(CONFIG.BACKEND_VERIFICATION_TOKEN_KEY);
        const backendTokenExists = backendToken && validateToken(backendToken);

        if (actionMatches && statusMatches && backendTokenExists) {
          showUIMessage('‚úÖ Verifica√ß√£o do portal completa! Solicitando ID de Tripulante...', 'success', 4000);
          
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);

          generateNewKey();
        } else {
          if (backendToken && (!actionMatches || !statusMatches)) {
            localStorage.removeItem(CONFIG.BACKEND_VERIFICATION_TOKEN_KEY);
          }
          fetchUserKeyList();
          if (elements.keyContainerEl) elements.keyContainerEl.classList.remove('visible');
        }
      } catch {
        fetchUserKeyList();
        if (elements.keyContainerEl) elements.keyContainerEl.classList.remove('visible');
      }
    }

    // ==================== WIDGET SYSTEM ====================
    function openDiscordWidget() {
      if (elements.discordWidgetContainer && elements.overlay) {
        elements.discordWidgetContainer.classList.add('active');
        elements.overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        if (appState.soundEnabled) {
          playSoundSequence([
            {freq: 523, duration: 100, type: 'sine'},
            {freq: 659, duration: 100, type: 'sine'}
          ]);
        }
      }
    }

    function closeDiscordWidget() {
      if (elements.discordWidgetContainer && elements.overlay) {
        elements.discordWidgetContainer.classList.remove('active');
        elements.overlay.classList.remove('active');
        document.body.style.overflow = 'auto';
        
        if (appState.soundEnabled) {
          playSound(400, 100, 'sine');
        }
      }
    }

    // ==================== TRANSLATION SYSTEM ====================
    function toggleTranslation() {
      if (!appState.isTranslated) {
        const translations = {
          'Terminal de Acesso - MIRA HQ': 'Access Terminal - MIRA HQ',
          'üßë‚ÄçüöÄ Tripulante, requisite sua Identifica√ß√£o de Acesso ou verifique os registros do ciclo atual. Mantenha-se alerta!': 'üßë‚ÄçüöÄ Crewmate, request your Access ID or check the current cycle logs. Stay alert!',
          '‚ö†Ô∏è SISTEMA EM COOLDOWN': '‚ö†Ô∏è SYSTEM IN COOLDOWN',
          'Aguarde para nova solicita√ß√£o': 'Wait for new request',
          'Voc√™ possui 0 IDs ativas (m√°ximo: 5 por tripulante)': 'You have 0 active IDs (maximum: 5 per crewmate)',
          'üí° Use suas IDs no mod Among Us para liberar espa√ßo': 'üí° Use your IDs in the Among Us mod to free up space',
          '‚ö†Ô∏è INICIAR TASK: REGISTRO': '‚ö†Ô∏è START TASK: REGISTRATION',
          'üõ∞Ô∏è LOG DE SISTEMA': 'üõ∞Ô∏è SYSTEM LOG',
          'ID de Tripulante Designada:': 'Assigned Crewmate ID:',
          'üìã Copiar ID': 'üìã Copy ID',
          'üìÖ Gerada em:': 'üìÖ Generated at:',
          'üîë Tipo: Acesso MIRA HQ': 'üîë Type: MIRA HQ Access',
          '‚è±Ô∏è Status: Ativa': '‚è±Ô∏è Status: Active',
          'Registros de IDs - Ciclo Atual': 'ID Records - Current Cycle',
          'Nenhum registro de ID neste terminal para o ciclo atual.': 'No ID records in this terminal for the current cycle.',
          'üåê Traduzir P√°gina': 'üåê Translate Page',
          'AUTENTICANDO NO SISTEMA MIRA HQ...': 'AUTHENTICATING IN MIRA HQ SYSTEM...',
          'üõ∞Ô∏è Link com Servidor Central MIRA HQ...': 'üõ∞Ô∏è Linking with MIRA HQ Central Server...',
          '‚úÖ ID de Acesso V√°lida! Prossiga com suas tarefas, Tripulante.': '‚úÖ Valid Access ID! Proceed with your tasks, Crewmate.',
          'Consultando Log de IDs do sistema...': 'Querying System ID Log...',
          'Relat√≥rio de IDs carregado.': 'ID report loaded.',
          'Nenhuma ID encontrada no log.': 'No ID found in the log.',
          '‚è≥ Iniciando verifica√ß√£o de seguran√ßa...': '‚è≥ Starting security verification...',
          '‚è≥ Preparando redirecionamento para o portal...': '‚è≥ Preparing redirect to portal...',
          '‚úÖ Verifica√ß√£o do portal completa! Solicitando ID de Tripulante...': '‚úÖ Portal verification complete! Requesting Crewmate ID...',
          '‚ö†Ô∏è ALERTA: Limite de requisi√ß√µes de ID atingido. Aguarde o pr√≥ximo ciclo.': '‚ö†Ô∏è ALERT: ID request limit reached. Wait for the next cycle.',
          'üö´ EMERG√äNCIA: Perda de comunica√ß√£o com o servidor. Poss√≠vel sabotagem!': 'üö´ EMERGENCY: Communication loss with server. Possible sabotage!',
          '‚è±Ô∏è AGUARDE: Sistema em cooldown. Aguarde o tempo restante antes de fazer nova solicita√ß√£o.': '‚è±Ô∏è WAIT: System in cooldown. Wait for the remaining time before making a new request.',
          '‚ö†Ô∏è LIMITE ATINGIDO: Voc√™ possui o m√°ximo de 5 IDs. Use uma ID no mod Among Us para liberar espa√ßo antes de gerar nova.': '‚ö†Ô∏è LIMIT REACHED: You have the maximum of 5 IDs. Use an ID in the Among Us mod to free up space before generating a new one.',
          'üö´ ERRO DE SEGURAN√áA: URL de verifica√ß√£o n√£o confi√°vel.': 'üö´ SECURITY ERROR: Untrusted verification URL.',
          '‚úÖ Sistema pronto para nova solicita√ß√£o!': '‚úÖ System ready for new request!',
          'üÜò Suporte': 'üÜò Support',
          'üéÆ Entrar com Discord': 'üéÆ Login with Discord',
          'üö™ Sair': 'üö™ Logout',
          'Membro do servidor': 'Server member',
          'Fora do servidor': 'Not in server',
          'Keys Hoje': 'Keys Today',
          'Total Keys': 'Total Keys',
          'Keys Ativas': 'Active Keys',
          'Membro desde': 'Member since',
          'üöÄ Gerar Nova Key': 'üöÄ Generate New Key',
          'Suporte - Discord': 'Support - Discord',
          'üîê Autentica√ß√£o necess√°ria': 'üîê Authentication required',
          'üö´ Sess√£o expirada ou inv√°lida': 'üö´ Session expired or invalid',
          'üîë Tripulante Veterano - 5 IDs geradas!': 'üîë Veteran Crewmate - 5 IDs generated!',
          'üîë Especialista em Seguran√ßa - 10 IDs!': 'üîë Security Expert - 10 IDs!',
          'üîë Primeiro Acesso - Bem-vindo √† MIRA HQ!': 'üîë First Access - Welcome to MIRA HQ!',
          'üéÆ Entre no nosso servidor Discord para gerar keys!': 'üéÆ Join our Discord server to generate keys!',
          'üöÄ Entrar no Servidor Crewbot': 'üöÄ Join Crewbot Server',
          'NO SERVIDOR': 'IN SERVER',
          'FORA DO SERVIDOR': 'NOT IN SERVER',
          'üîê LOGIN REQUERIDO': 'üîê LOGIN REQUIRED',
          'üéÆ SERVIDOR N√ÉO VERIFICADO': 'üéÆ SERVER NOT VERIFIED',
          'Sistema MIRA HQ Online': 'MIRA HQ System Online'
        };

        Object.keys(translations).forEach(key => {
          const elements = document.querySelectorAll('*');
          elements.forEach(element => {
            if (element.childNodes.length === 1 && element.childNodes[0].nodeType === Node.TEXT_NODE) {
              if (element.textContent.includes(key)) {
                element.textContent = element.textContent.replace(key, translations[key]);
              }
            }
          });
        });

        appState.isTranslated = true;
        elements.translateButton.textContent = 'üáßüá∑ Voltar ao Portugu√™s';
      } else {
        location.reload();
      }
    }

    // ==================== STARFIELD ====================
    function createStars() {
      if (!elements.starfield) return;
      
      elements.starfield.innerHTML = '';
      
      try {
        const numStarsBase = Math.min(200, Math.floor((window.innerWidth * window.innerHeight) / 15000));
        const starLayersData = [
          { class: 'star-layer1', count: Math.floor(numStarsBase * 0.3), baseSize: 0.4 },
          { class: 'star-layer2', count: Math.floor(numStarsBase * 0.4), baseSize: 0.7 },
          { class: 'star-layer3', count: Math.floor(numStarsBase * 0.3), baseSize: 1.1 }
        ];
        
        starLayersData.forEach(layer => {
          for (let i = 0; i < layer.count; i++) {
            const star = document.createElement('div');
            star.classList.add('star', layer.class);
            star.style.left = `${Math.random() * 100}vw`;
            star.style.top = `${Math.random() * 100}vh`;
            
            const size = layer.baseSize + Math.random() * 0.7;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            
            if (Math.random() > 0.7) {
              const colors = ['#ffffff', '#f8f8ff', '#e6f7ff', '#fff8e6'];
              star.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            }
            
            elements.starfield.appendChild(star);
          }
        });
      } catch {}
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      if (elements.soundToggle) {
        elements.soundToggle.addEventListener('click', () => {
          appState.soundEnabled = !appState.soundEnabled;
          updateSoundToggle();
          initAudioContext();
          
          if (appState.soundEnabled) {
            playSoundSequence([
              {freq: 440, duration: 100, type: 'sine'},
              {freq: 554, duration: 100, type: 'sine'}
            ]);
          }
        });
      }

      if (elements.copyButton) {
        elements.copyButton.addEventListener('click', copyToClipboard);
      }

      if (elements.btnGen) {
        elements.btnGen.addEventListener('click', initiateShortenerRedirect);
      }

      if (elements.btnView) {
        elements.btnView.addEventListener('click', () => {
          if (appState.soundEnabled) playSound(500, 100, 'square');
          fetchUserKeyList();
        });
      }

      if (elements.translateButton) {
        elements.translateButton.addEventListener('click', toggleTranslation);
      }

      if (elements.supportButton) {
        elements.supportButton.addEventListener('click', openDiscordWidget);
      }

      if (elements.closeWidget) {
        elements.closeWidget.addEventListener('click', closeDiscordWidget);
      }

      if (elements.overlay) {
        elements.overlay.addEventListener('click', closeDiscordWidget);
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && elements.discordWidgetContainer.classList.contains('active')) {
          closeDiscordWidget();
        }
      });

      window.addEventListener('beforeunload', () => {
        if (appState.cooldownTimer) {
          clearInterval(appState.cooldownTimer);
        }
      });
      
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(createStars, 400);
      });
    }

    // Adicione esta fun√ß√£o para verificar periodicamente a sess√£o
    function setupSessionWatcher() {
      // Verificar a sess√£o a cada minuto
      setInterval(async () => {
        if (discordAuth.isAuthenticated) {
          const isValid = await discordAuth.validateSession();
          if (!isValid) {
            console.log('Sess√£o expirada, fazendo logout...');
            await discordAuth.logout();
          }
        }
      }, 60000); // 1 minuto
    }

    // ==================== INITIALIZATION ====================
    function initializeApp() {
      try {
        appState.soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        appState.keyGenerationCount = Math.max(0, parseInt(localStorage.getItem('keyGenerationCount') || '0'));
        appState.lastKeyGenerationTime = Math.max(0, parseInt(localStorage.getItem('lastKeyGenerationTime') || '0'));
        
        if (appState.keyGenerationCount > 10000) appState.keyGenerationCount = 0;
        if (appState.lastKeyGenerationTime > Date.now() + 86400000) appState.lastKeyGenerationTime = 0;
      } catch {
        appState.soundEnabled = false;
        appState.keyGenerationCount = 0;
        appState.lastKeyGenerationTime = 0;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      updateSoundToggle();
      createStars();
      checkCooldownOnLoad();
      setupEventListeners();
      checkAndProcessShortenerReturn();
      discordAuth.init();
      setupSessionWatcher();
      
      setTimeout(() => {
        if (appState.soundEnabled) {
          playSoundSequence([
            {freq: 220, duration: 100, type: 'sine'},
            {freq: 277, duration: 100, type: 'sine'},
            {freq: 330, duration: 100, type: 'sine'},
            {freq: 440, duration: 200, type: 'sine'}
          ]);
        }
      }, 1000);
    });
  </script>
</body>
</html>
